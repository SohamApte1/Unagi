#####################################################################
#   Fan Control
#####################################################################

##  Print Cooling Fan - FAN0
[fan]
pin: nhk:gpio6
kick_start_time: 0.5
##  Depending on your fan, you may need to increase this value
##  if your fan will not start. Can change cycle_time (increase)
##  if your fan is not able to slow down effectively
off_below: 0.10


##  Hotend Fan
[heater_fan hotend_fan]
pin: nhk:gpio5
max_power: 1.0
kick_start_time: 0.5
heater: extruder
heater_temp: 50.0
##  If you are experiencing back flow, you can reduce fan_speed
#fan_speed: 1.0

##  Controller fan 1
[controller_fan controller_fan1]
pin: PD12
kick_start_time: 0.5
heater: heater_bed
cycle_time: 0.025

##  Controller fan 2
[controller_fan controller_fan2]
pin: PD13
kick_start_time: 0.5
heater: heater_bed
cycle_time: 0.025

## Bed Fans
[heater_generic heater_chamber]  # Treating the bed fans as a chamber heater to enable PID control
heater_pin: PE5   #Pin on the BTT Octopus that the bed fans are plugged into (4 fans in one port via fan splitter PCB)
max_power: 1.0
sensor_type: temperature_combined
sensor_list: temperature_sensor _chamber_upper, temperature_sensor _chamber_toolhead
combination_method: mean
maximum_deviation: 100
control: pid
pid_Kp: 61.470837
pid_Ki: 0.5
pid_Kd: 0
pwm_cycle_time: 0.3
min_temp: -273.15
max_temp: 75

[verify_heater heater_chamber]   # Prevents "heater not heating at expected rate" Klipper shutdown when chamber temp is set while bed is cold/heating up
                                 # DO NOT MODIFY THIS CODE BLOCK FOR ANY OTHER HEATER
max_error: 120
check_gain_time: 120
hysteresis: 50
heating_gain: 1

[gcode_macro SET_CHAMBER]
gcode:
  {% set chamber_target = params.CHAMBER_TEMP|default(0)|float %}
  SET_HEATER_TEMPERATURE heater=heater_chamber target={chamber_target}